#!/bin/bash

function append_var_if_defined
{
    VAR_NAME=$1
    OUTPUT=$2
    grep -qE "^${VAR_NAME}=" ${OUTPUT}||env|grep -E "^${VAR_NAME}=">>${OUTPUT}
}
VAR_LIST="DD_AGENT_APP DD_TRACE_DEBUGDD_AGENT_ENV DD_AGENT_HOST SESAME_API_SETTINGS RAILS_DB_HOST RAILS_DB_PORT RAILS_DB_USER RAILS_DB_PASSWORD RAILS_DB_NAME PUBLIC_HOST MAIL_FROM SMTP_HOST SECRET_BASE CODIFLIGNE_API_URL REFLEX_API_URL REDIS_CACHE_STORE_URL RAILS_LOG_TO_STDOUT PATH NR_LICENCE_KEY CHOUETTE_CLEAN_TEST_ORGANISATIONS AUTOMATED_AUDITS_ENABLED CHOUETTE_EMAIL_USER CHOUETTE_EMAIL_WHITELIST CHOUETTE_EMAIL_BLACKLIST REFERENTIALS_CLEANING_COOLDOWN TZ SMTP_SETTINGS PUBLIC_HOST MAIL_DELIVERY_METHOD MAIL_FROM"

# Required by ruby docker image
VAR_LIST+=" GEM_HOME BUNDLE_APP_CONFIG BUNDLE_PATH BUNDLE_SILENCE_ROOT_WARNING"

TMPF=$(tempfile)
for v in $VAR_LIST; do
    append_var_if_defined $v $TMPF
done

crontab -l >> $TMPF
cat $TMPF |crontab -
rm $TMPF

exec cron -f
